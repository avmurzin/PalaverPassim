<!DOCTYPE html>
<html>
    <head>
     <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" href="codebase/webix.css" type="text/css" media="screen" charset="utf-8">
        <script src="codebase/webix.js" type="text/javascript" charset="utf-8"></script>
        <style>

            .blue.webix_menu-x{
                background:#3498DB;
            }
        </style>
        
        <title>Управление телефонными конференциями</title>
    </head>
    <style type="text/css">
        .mark{
            width:100px;
            text-align: center;
            font-weight:bold;
            float:right;
            background-color:#777;
            color:white;
            border-radius:3px;
        }
        .info{
            width:100px;
            text-align: center;
            font-weight:normal;
            float:right;
            background-color:#F99;
            color:white;
            border-radius:3px;
        }
    </style>
    
    <body>
<script type="text/javascript" charset="utf-8">

//содержимое главного меню
var menu_data = [
    { id:"1",value:"Конференция", submenu:[
        {id: "1.1", value: "Создать"}, 
        {id: "1.2", value: "Изменить"},
        {id: "1.3", value: "Удалить"}
    ]}
];


//объект главного меню
var menu = {
    view:"menu",
    id: "top_menu",
    data: menu_data,
    css:"blue",
    type:{
        subsign:true,

    },
    on:{
        onMenuItemClick:function(id){
            //menuSelect(id);
        }
        }
};


//тулбар справа от главного меню
var toolbar = {
        view:"toolbar", paddingY:0,  elements:[
            {}, 
            { view:"label", id:"logged_user", value: "", align: "right"},
            { view:"button", label:"Выйти", width:100, on:{
                onItemClick:function(){
                    logout();
                }
                } }
        ]
    };
    
//дерево контейнеров (правый блок)
var container_tree = {
    view : "tree",
    id : "container_tree",
    select : true,
    type:"lineTree",
    template:"{common.icon()} <img src='images/#image#.png' style='float:left; margin:3px 4px 0px 1px;'> <span>#value#</span>",
    data : [{id: "123", value: "Требуется залогиниться", image: "group"}],
    on:{
        onItemClick:function(id){
            //container_properties(id);
        }
       }
};    

//форма создания палавера
var create_palaver = {
		view:"form", id: "palaver_form", scroll:false, elements:[
                                      { view:"text", label:"Описание", name:"description", value:"Новая встреча", width:300},
                                      {view:"select", id:"conference_select", name:"conference" ,label:"Комната", options:"conference", labelAlign: 'left'},
		                              { view:"datepicker", timepicker:true, label:"Начало", name:"start", stringResult:false, format:"%d.%m.%Y %H:%i", on:{
		                            	  onChange:function(){
		                            		  //var name = this.getParentView().getValues().start;
		                            		  //this.getParentView().setValues({ end: name }, true); 
		                            		  update_form();
		                                  }
		                                  }  },
		                              { view:"datepicker", timepicker:true, label:"Конец", name:"end", stringResult:false, format:"%d.%m.%Y %H:%i", on:{
                                          onChange:function(){
                                              update_form();
                                          }
                                          }  },
                                      { view:"button", type:"form", value:"Создать", click:function(){
                                    	  createPalaver();
		                                     }}
		                                 ]
		
}

function update_form() {
	var start = $$('palaver_form').getValues().start;
	var startTimestamp = start.getTime() / 1000;
	var end = $$('palaver_form').getValues().end;
	var stopTimestamp = startTimestamp + 86400;
	if (end != null) {
		stopTimestamp = end.getTime() / 1000;
	}
	
    $$("container_tree").clearAll();
    webix.ajax("palaver/timeline?startTimestamp=" + startTimestamp + "&stopTimestamp=" + stopTimestamp, function(text, data) {
        $$("container_tree").parse(data.json());
        $$("container_tree").openAll();
        $$("container_tree").refresh();

    });
}

//верстка страницы интерфейса
webix.ui({
    rows:[
        {type:"clean", cols: [menu,toolbar]},
        { cols: [{rows: [{view: "label", label:"<span class='webix_property_label_line'>Создать новую встречу</span>"}, 
                         create_palaver, {}]}, 
                 {view:"resizer"}, 
                 {rows: [{view: "label", label:"<span class='webix_property_label_line'>Ранее запланированные на тот же период встречи</span>"}, container_tree]}]}
    ]
});

//создание палавера
function createPalaver() {
	var startTimestamp = $$('palaver_form').getValues().start.getTime() / 1000;
	var stopTimestamp = $$('palaver_form').getValues().end.getTime() / 1000;
	var description = $$('palaver_form').getValues().description;
	
    webix.ajax().post("palaver/" + description + "/" + startTimestamp + "/" + stopTimestamp, {}, function(text, data) {
        if (data.json().result == false) {
            webix.alert(data.json().message);
        } else {
        	update_tree();
        }
    });
};


//тестовая функция создания абонента
var abonent = {
		fName: "Иван",
		mName: "Иванович",
		lName: "Иванов",
		description: "просто абонент",
		address: "просто адрес"
};

function createAbonent() {
	
    webix.ajax().headers({"Content-type":"application/json"}).post("abonent", 
    		JSON.stringify(abonent), 
    		function(text, data) {
        if (data.json().result == false) {
            webix.alert("Error!");
        } else {
            webix.alert(data.json().message);
        }
    });
};

function update_tree() {
    $$("container_tree").clearAll();
    webix.ajax("palaver/timeline", function(text, data) {
    	
        $$("container_tree").parse(data.json());
        $$("container_tree").openAll();
        $$("container_tree").refresh();

    });
}

//окно загрузилось
webix.attachEvent("onReady", function(){
	update_tree();
	 
});

function logout() {
    webix.message("Выход")
    window.location.assign("auth/signOut");
}
</script>
    </body>
</html>